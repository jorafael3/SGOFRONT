import{b as h}from"./chunk-3EDIKQYL.js";import{d as m,l as p}from"./chunk-4QEBWWP4.js";import{H as g,Z as o,ca as d,ha as u,l as a,p as l}from"./chunk-NIELWWGW.js";var c=[{id:1,name:"admin",displayName:"Administrador",color:"danger",permissions:["users.view","users.create","users.edit","users.delete","companies.view","companies.create","companies.edit","companies.delete","reports.view","reports.export","settings.view","settings.edit"]},{id:2,name:"user",displayName:"Usuario",color:"primary",permissions:["dashboard.view","profile.view","profile.edit"]},{id:3,name:"supervisor",displayName:"Supervisor",color:"warning",permissions:["users.view","users.edit","reports.view","dashboard.view","profile.view","profile.edit"]}],n=class{static getRoleById(s){return c.find(e=>e.id===s)}static getRoleByName(s){return c.find(e=>e.name===s)}static getRoleDisplayName(s){return this.getRoleById(s)?.displayName||"Usuario"}static hasPermission(s,e){return this.getRoleById(s)?.permissions.includes(e)||!1}static getRoleColor(s){return this.getRoleById(s)?.color||"secondary"}static getAllRoles(){return c}};var f=class i extends h{constructor(e,r){super(e);this.router=r;this.checkCurrentUser()}TESTING_MODE=!1;currentUserSubject=new a(null);currentUser$=this.currentUserSubject.asObservable();isLoggedInSubject=new a(!1);isLoggedIn$=this.isLoggedInSubject.asObservable();login(e){if(console.log("Login attempt with credentials:",e),this.TESTING_MODE){let r={success:!0,message:"Login exitoso (modo testing)",user_data:{id_usuario:1,id_empresa:1,id_rol:2,usuario:e.username,nombre:"Usuario Test",apellido:"Test",telefono:"0999999999",email:e.username+"@test.com",estado:"A",creado_por:"admin",fecha_creacion:new Date().toISOString(),token:"fake-jwt-token-for-testing-"+Date.now()}};return console.log("Mock response:",r),l(r).pipe(o(t=>{if(t.success&&t.user_data){let b=this.mapApiUserToUser(t.user_data);this.setUserSession(b,t.user_data.token)}}))}else return this.post("/login/login/authenticate",e).pipe(o(r=>{console.log("API response:",r),r.success&&r.user_data&&this.setUserSession(r.user_data,r.user_data.token)}))}mapApiUserToUser(e){return{id:e.usrid,username:e.usuario,email:e.email,name:`${e.nombre}`,role:this.getRoleName(e.id_rol),id_empresa:e.empleado_empresa,id_empleado:e.EmpleadoID,id_rol:e.id_rol,estado:e.anulado}}getRoleName(e){return n.getRoleDisplayName(e)}logout(){console.log("Logging out user...");let e=this.getCurrentUser();return this.clearUserSession(),this.post("/login/logout",{user_id:e?.id}).pipe(o({next:r=>{console.log("Server logout response:",r)},error:r=>{console.warn("Server logout failed, but local session cleared:",r)},finalize:()=>{console.log("Navigating to login page..."),this.router.navigate(["/auth/login"])}}),g(r=>(console.warn("Logout API error (ignoring):",r),l({success:!0,message:"Sesi\xF3n cerrada localmente"}))))}register(e){return this.post("/auth/register",e)}refreshToken(){let e=localStorage.getItem("refreshToken");return this.post("/auth/refresh",{refreshToken:e}).pipe(o(r=>{if(r.success&&r.user_data){let t=this.mapApiUserToUser(r.user_data);this.setUserSession(t,r.user_data.token)}}))}forgotPassword(e){return this.post("/auth/forgot-password",{email:e})}resetPassword(e,r){return this.post("/auth/reset-password",{token:e,newPassword:r})}getCurrentUser(){return this.currentUserSubject.value}isLoggedIn(){return this.isLoggedInSubject.value}setUserSession(e,r,t){console.log("Setting user session:",{user:e,token:r}),localStorage.setItem("user",JSON.stringify(e)),localStorage.setItem("authToken",r),t&&localStorage.setItem("refreshToken",t),this.currentUserSubject.next(e),this.isLoggedInSubject.next(!0),console.log("User session set successfully. IsLoggedIn:",this.isLoggedIn()),console.log("Current user:",this.getCurrentUser())}clearUserSession(){localStorage.removeItem("user"),localStorage.removeItem("authToken"),localStorage.removeItem("refreshToken"),this.currentUserSubject.next(null),this.isLoggedInSubject.next(!1)}checkCurrentUser(){let e=localStorage.getItem("user"),r=localStorage.getItem("authToken");if(e&&r)try{let t=JSON.parse(e);this.currentUserSubject.next(t),this.isLoggedInSubject.next(!0)}catch(t){console.error("Error parsing user data:",t),this.clearUserSession()}}static \u0275fac=function(r){return new(r||i)(u(m),u(p))};static \u0275prov=d({token:i,factory:i.\u0275fac,providedIn:"root"})};export{f as a};
